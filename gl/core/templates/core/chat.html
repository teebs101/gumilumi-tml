{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumi Chat | Code & Magic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" />
    
    
    <style type="text/tailwindcss">

        @layer base {
    ul, ol {
        list-style: none;
        padding-left: 0;
        margin-left: 0;
    }

    li::marker {
        content: "";
    }
}

        @layer base {
            html, body {
                @apply m-0 p-0 overflow-hidden w-full h-full bg-[#fff0f3];
                font-family: 'Fredoka', sans-serif;
            }
            code, pre {
                font-family: 'JetBrains Mono', monospace !important;
            }
        }
        @layer components {
            .floating-lumi { animation: float 3s ease-in-out infinite; }
            @keyframes float {
                0%, 100% { transform: translateY(0) rotate(0deg); }
                50% { transform: translateY(-12px) rotate(3deg); }
            }

            .bubble-lumi { @apply bg-white/90 backdrop-blur-md rounded-[2.5rem] rounded-tl-none border border-rose-100 shadow-xl shadow-rose-200/30 text-slate-700; }
            .bubble-user { 
                @apply text-white rounded-[2.5rem] rounded-tr-none shadow-2xl shadow-rose-400/40; 
                background: linear-gradient(135deg, #ff4d6d 0%, #ff758f 100%); 
            }

            /* Estilo para los bloques de código que vienen del views.py */
            .code-block {
                @apply bg-slate-900 text-pink-300 p-5 rounded-3xl my-4 border-l-4 border-rose-500 overflow-x-auto text-sm shadow-inner font-mono;
            }

            .sug-card { 
                @apply w-full p-4 bg-white/60 backdrop-blur-sm rounded-3xl text-left text-sm font-bold text-slate-600 border-2 border-white/50 hover:border-rose-400 hover:text-rose-500 hover:shadow-[0_0_20px_rgba(255,182,193,0.5)] transition-all duration-300 flex items-center gap-3 active:scale-95; 
            }

            .magic-dot { @apply absolute rounded-full opacity-40 animate-pulse; }
            
            .msg-in { animation: popIn 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
            @keyframes popIn {
                0% { opacity: 0; transform: scale(0.8) translateY(30px); }
                100% { opacity: 1; transform: scale(1) translateY(0); }
            }
            .no-scrollbar::-webkit-scrollbar { display: none; }
            
            .nav-btn {
                @apply flex items-center gap-2 px-5 py-2 rounded-full border-2 border-transparent font-bold text-slate-400 transition-all hover:bg-white hover:text-slate-600;
            }
        }

        /* 1. Forzamos que todos los iconos dentro del nav estén rellenos */
header nav .material-symbols-outlined, 
.navbar .material-symbols-outlined {
    font-variation-settings: 
        'FILL' 1,   /* 1 para relleno, 0 para contorno */
        'wght' 400, /* Grosor del icono */
        'GRAD' 0, 
        'opsz' 24 !important;
}

/* 2. Tu código anterior actualizado para que los bordes y fondos combinen */
header nav a, .nav-item {
    opacity: 1 !important;
    font-weight: 800 !important;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px !important;
    border-radius: 18px !important; /* Más redondeado, más cute */
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
}

/* Colores con fondo sutil para que el icono relleno resalte más */
header nav a:nth-child(1), .nav-inicio { color: #2563eb !important; background: #eff6ff !important; border: 2px solid #dbeafe !important; }
header nav a:nth-child(2), .nav-cursos { color: #b45309 !important; background: #fffbeb !important; border: 2px solid #fef3c7 !important; }
header nav a:nth-child(3), .nav-terminal { color: #be185d !important; background: #fdf2f8 !important; border: 2px solid #fce7f3 !important; }
header nav a:nth-child(4), .nav-logros { color: #15803d !important; background: #f0fdf4 !important; border: 2px solid #dcfce7 !important; }
header nav a:nth-child(5), .nav-chat { color: #db2777 !important; background: #fff1f2 !important; border: 2px solid #fdf2f8 !important; }
header nav a:nth-child(6), .nav-cuenta { color: #1d4ed8 !important; background: #eff6ff !important; border: 2px solid #dbeafe !important; }

/* 3. Animación de rebote en el icono al pasar el mouse */
header nav a:hover .material-symbols-outlined {
    transform: scale(1.2) rotate(5deg);
    transition: transform 0.2s ease;
}

    </style>
</head>
<body>

<div class="fixed inset-0 pointer-events-none">
    <div class="magic-dot w-20 h-20 bg-rose-200 blur-3xl top-10 left-10"></div>
    <div class="magic-dot w-32 h-32 bg-blue-100 blur-3xl bottom-20 right-20"></div>
</div>

<div class="h-screen w-full flex flex-col overflow-hidden relative z-10">
    
    <header class="flex items-center justify-between border-b border-[#e8edf3] px-10 py-3 bg-white">
    
    <div class="flex items-center gap-4">
        <span class="material-symbols-outlined text-primary text-3xl">school</span>
        <h2 class="text-xl font-bold">Gumi & Lumi</h2>
    </div>

<nav class="flex items-center gap-3">

{% with current=request.resolver_match.url_name %}

<a href="{% url 'dashboard' %}"
   class="group flex items-center gap-2 px-5 py-2 rounded-full border-2 font-bold transition-all duration-300
   {% if current == 'dashboard' %}
      bg-soft-blue border-blue-500 text-blue-900 shadow-md
   {% else %}
      border-soft-blue text-soft-blue hover:bg-soft-blue hover:bg-pastel-blue hover:text-primary hover:-translate-y-1 hover:scale-105
   {% endif %}">
   <span class="material-symbols-outlined">home</span>
   Inicio
</a>

<a href="{% url 'courses' %}"
   class="group flex items-center gap-2 px-5 py-2 rounded-full border-2 font-bold transition-all duration-300
   {% if current == 'courses' %}
      bg-pastel-yellow border-star-yellow text-[#7a5c00] shadow-md
   {% else %}
      border-star-yellow text-[#a07800]  hover:-translate-y-1 hover:scale-105
   {% endif %}">
   <span class="material-symbols-outlined">school</span>
   Cursos
</a>

<a href="{% url 'terminal_libre' %}" 
       class="group flex items-center gap-2 px-5 py-2 rounded-full border-2 font-bold transition-all duration-300
       {% if current == 'terminal_libre' %}
          bg-slate-700 border-slate-900 text-white shadow-md
       {% else %}
          border-slate-800 bg-slate-800 text-white hover:bg-slate-700 hover:-translate-y-1 hover:scale-105
       {% endif %}">
        <span class="material-symbols-outlined">terminal</span> 
        Terminal
    </a>

<a href="{% url 'logros' %}"
   class="group flex items-center gap-2 px-5 py-2 rounded-full border-2 font-bold transition-all duration-300
   {% if current == 'logros' %}
      bg-pastel-green border-hill-green text-green-900 shadow-md
   {% else %}
      border-hill-green text-green-700 hover:bg-pastel-green hover:-translate-y-1 hover:scale-105
   {% endif %}">
   <span class="material-symbols-outlined">emoji_events</span>
   Logros
</a>

<a href="{% url 'chat' %}"
   class="group flex items-center gap-2 px-5 py-2 rounded-full border-2 font-bold transition-all duration-300
   {% if current == 'chat' %}
      bg-soft-pink border-primary-pink text-pink-900 shadow-md
   {% else %}
      border-soft-pink text-pink-700 hover:bg-soft-pink hover:text-pink-900 hover:-translate-y-1 hover:scale-105
   {% endif %}">
   <span class="material-symbols-outlined">chat</span>
   Chat
</a>

<a href="{% url 'account' %}"
   class="group flex items-center gap-2 px-5 py-2 rounded-full border-2 font-bold transition-all duration-300
   {% if current == 'account' %}
      bg-soft-blue border-primary text-blue-900 shadow-md
   {% else %}
      border-soft-blue text-blue-700 hover:bg-soft-blue hover:text-blue-900 hover:-translate-y-1 hover:scale-105
   {% endif %}">
   <span class="material-symbols-outlined">person</span>
   Cuenta
</a>

{% endwith %}
</nav>

    <div class="flex items-center gap-3 bg-slate-50 p-2 rounded-[1.5rem]">
        <div class="size-9 rounded-full bg-white border-2 shadow-sm overflow-hidden p-1">
            {% if user.profile.avatar == 'lumi' %}
                <img src="{% static 'core/img/lumi_icon.png' %}" class="w-full h-full object-contain">
            {% else %}
                <img src="{% static 'core/img/gumi_icon.png' %}" class="w-full h-full object-contain">
            {% endif %}
        </div>
        <div class="flex-1">
            <p class="text-xs font-black truncate">{{ user.username }}</p>
            <p class="text-[9px] font-bold text-slate-400 uppercase">Nivel {{ user.profile.level }}</p>
        </div>
        <a href="{% url 'logout' %}">
            <span class="material-symbols-outlined text-slate-300 hover:text-red-400">logout</span>
        </a>
    </div>
</header>

    <div class="flex-1 flex gap-6 p-6 min-h-0 relative">
        
        <aside class="w-[280px] flex flex-col gap-6 h-full shrink-0">
            <div class="flex-1 bg-white/60 backdrop-blur-xl rounded-[3rem] p-8 shadow-xl border border-white/80 flex flex-col overflow-hidden">
                <div class="flex items-center gap-2 mb-6">
                    <span class="material-symbols-outlined text-rose-400">auto_awesome</span>
                    <h3 class="text-slate-400 font-bold text-[10px] uppercase tracking-widest">Sugerencias</h3>
                </div>
                <div class="flex-1 overflow-y-auto no-scrollbar space-y-4">
                    <button onclick="useSuggestion('¿Qué es una variable en este proyecto?')" class="sug-card">
                        <span>PY</span> Conceptos básicos
                    </button>

                    <button onclick="useSuggestion('¿Cómo funciona la terminal de esta plataforma?')" class="sug-card">
                        <span>WEB</span> Terminal interactiva
                    </button>

                   <button onclick="useSuggestion('¿Cómo gano experiencia o avanzo de nivel?')" class="sug-card">
                        <span>XP</span> Progreso y niveles
                    </button>

                </div>
            </div>
            
            <div class="h-32 bg-slate-800 rounded-[2.5rem] p-6 text-white shadow-2xl relative overflow-hidden group border-4 border-white">
                <div class="absolute inset-0 bg-gradient-to-br from-rose-500/20 to-transparent"></div>
                <p class="text-[9px] font-bold uppercase text-rose-300 mb-1">Status de Magia</p>
                <p class="text-xs font-medium">Conectado al Reino de Cristal ✨</p>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-white/40 backdrop-blur-3xl rounded-[4rem] shadow-2xl overflow-hidden relative border-4 border-white/60">
            <div id="chat-box" class="flex-1 overflow-y-auto px-10 py-10 flex flex-col gap-8 no-scrollbar scroll-smooth">
                <div class="flex items-start gap-4 max-w-[85%] msg-in">
                    <div class="w-14 h-14 bg-white rounded-2xl p-2 shadow-lg border border-rose-100 shrink-0 floating-lumi">
                        <img src="{% static 'core/img/lumi_icon.png' %}" class="w-full h-full object-contain">
                    </div>
                    <div class="flex flex-col gap-2">
                        <div class="bubble-lumi p-7 font-medium text-lg leading-relaxed">
                            ¡Hola, {{ user.username }} ^-^ <br>
                            Soy Lumi. Estoy aquí para ayudarte a entender cómo funciona esta plataforma,
                            guiarte por los retos y explicarte los conceptos que aparecen en cada reino.
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="typing-indicator" class="hidden px-12 pb-4">
                <div class="flex gap-2 p-3 bg-white/80 rounded-full w-20 shadow-sm border border-rose-50">
                    <div class="w-2 h-2 bg-rose-300 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-rose-400 rounded-full animate-bounce [animation-delay:0.2s]"></div>
                </div>
            </div>

            <div class="px-12 pb-10 pt-2 shrink-0">
                <form id="chat-form" class="bg-white/90 rounded-[2.5rem] p-2 shadow-2xl flex items-center border border-white focus-within:ring-4 ring-rose-200/50 transition-all">
                    <input id="user-input" type="text" autocomplete="off" placeholder="Escribe tu duda sobre la plataforma, un concepto o un reto..." 
                        class="flex-1 bg-transparent px-6 py-4 text-slate-700 font-bold text-lg outline-none border-none focus:ring-0">
                    <button type="submit" class="bg-slate-800 hover:bg-rose-500 text-white w-16 h-16 rounded-[2rem] flex items-center justify-center shadow-lg transition-all active:scale-90">
                        <span class="material-symbols-outlined text-2xl">bolt</span>
                    </button>
                </form>
            </div>
        </main>

        <aside class="w-[320px] bg-white/70 backdrop-blur-md rounded-[3.5rem] p-10 shadow-xl border border-white flex flex-col h-full shrink-0 overflow-hidden">
            <h3 class="text-slate-800 font-black text-center mb-10 uppercase tracking-widest text-[10px]">✨ Grimorio</h3>
            <div class="flex-1 overflow-y-auto no-scrollbar space-y-5">
                <div class="p-4 bg-white/50 rounded-3xl border-l-4 border-rose-400">
                    <code class="text-xs font-bold text-slate-700 block mb-1">ls</code>
                    <p class="text-[10px] text-slate-500 leading-relaxed font-medium">Mira qué hay en tu carpeta actual. Comando tradicional de Linux.  
    En esta plataforma no se ejecuta directamente,
    ya que la terminal funciona con Python en el navegador.</p>
                </div>
                <div class="p-4 bg-white/50 rounded-3xl border-l-4 border-blue-400">
                    <code class="text-xs font-bold text-slate-700 block mb-1">if / else</code>
                    <p class="text-[10px] text-slate-500 leading-relaxed font-medium">Función usada para mostrar información en la terminal simulada
    y verificar resultados durante los retos.</p>
                </div>
            </div>
        </aside>
    </div>
</div>

<script>
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const chatBox = document.getElementById('chat-box');
    const typingIndicator = document.getElementById('typing-indicator');
    
    const lumiImg = "{% static 'core/img/lumi_icon.png' %}";
    const userImg = "{% if user.profile.avatar == 'lumi' %}{% static 'core/img/lumi_icon.png' %}{% else %}{% static 'core/img/gumi_icon.png' %}{% endif %}";

    function getMagicTime() {
        return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function parseMagicMarkdown(text) {
    // eliminar bullets unicode invisibles
    text = text.replace(/^[\s•●▪◦]+/gm, '');

    // bloques de código
    text = text.replace(/```python\n?([\s\S]+?)```/g,
        '<div class="code-block"><pre><code>$1</code></pre></div>'
    );

    // negritas
    text = text.replace(/\*\*(.*?)\*\*/g,
        '<strong class="text-rose-600 font-bold">$1</strong>'
    );

    // código inline
    text = text.replace(/`([^`]+)`/g,
        '<code class="bg-slate-800 text-pink-300 px-2 py-0.5 rounded-lg font-mono text-sm shadow-sm">$1</code>'
    );

    return text.replace(/\n/g, '<br>');
}


    // ESTA FUNCIÓN ELIMINA EL CÍRCULO NEGRO
    function typeWriter(element, htmlContent, speed = 10) {
        let i = 0;
        element.innerHTML = "";
        
        function type() {
            if (i < htmlContent.length) {
                // Si viene una etiqueta <code o <div, la ponemos entera de una vez
                if (htmlContent.charAt(i) === '<') {
                    let tagEnd = htmlContent.indexOf('>', i);
                    element.innerHTML += htmlContent.substring(i, tagEnd + 1);
                    i = tagEnd + 1;
                } else {
                    element.innerHTML += htmlContent.charAt(i);
                    i++;
                }
                setTimeout(type, speed);
                chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'instant' });
            }
        }
        type();
    }

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const msg = userInput.value.trim();
        if(!msg) return;
        
        userInput.value = '';
        appendBubble('user', msg);
        
        typingIndicator.classList.remove('hidden');
        chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });

        try {
            const response = await fetch('/api/chat/', {
                method: 'POST',
                body: JSON.stringify({ message: msg }),
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}' 
                }
            });
            const data = await response.json();
            
            setTimeout(() => {
                typingIndicator.classList.add('hidden');
                appendBubble('lumi', data.respuesta, true);
            }, 600);

        } catch (error) {
            typingIndicator.classList.add('hidden');
            appendBubble('lumi', "Mi cristal se empañó... o_o ¿Repetimos?");
        }
    });

    function appendBubble(type, text, animate = false) {
        const isLumi = type === 'lumi';
        const bubbleId = `msg-${Date.now()}`;
        const html = `
            <div class="flex items-start gap-4 ${isLumi ? '' : 'justify-end self-end ml-auto'} max-w-[90%] msg-in">
                ${isLumi ? `<div class="w-14 h-14 bg-white rounded-2xl p-2 shadow-lg border border-rose-100 shrink-0 floating-lumi"><img src="${lumiImg}" class="w-full h-full object-contain"></div>` : ''}
                <div class="flex flex-col ${isLumi ? 'items-start' : 'items-end'}">
                    <div id="${bubbleId}" class="${isLumi ? 'bubble-lumi' : 'bubble-user'} px-7 py-5 font-bold text-lg shadow-xl">
                        ${animate ? "" : parseMagicMarkdown(text)}
                    </div>
                    <span class="opacity-40 text-[10px] font-bold uppercase mt-1 ${isLumi ? 'ml-4' : 'mr-4'}">
                        ${isLumi ? 'Lumi AI' : 'Tú'} • ${getMagicTime()}
                    </span>
                </div>
                ${!isLumi ? `<div class="w-12 h-12 bg-white rounded-2xl p-1.5 shadow-md border border-blue-100 shrink-0"><img src="${userImg}" class="w-full h-full object-contain"></div>` : ''}
            </div>`;
        
        chatBox.insertAdjacentHTML('beforeend', html);
        
        if (animate) {
            typeWriter(document.getElementById(bubbleId), parseMagicMarkdown(text));
        } else {
            chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
        }
    }
</script>
</body>
</html>