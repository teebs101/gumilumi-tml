{% extends 'base/base_private.html' %}
{% load static %}

{% block title %}Mi Perfil Explorador | Gumi & Lumi{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<div class="min-h-screen bg-[#fff9fb] relative overflow-hidden py-8 px-4 md:py-12">
    
    <div id="magic-background" class="fixed inset-0 pointer-events-none z-0"></div>

    <div class="max-w-6xl mx-auto mb-8 flex justify-between items-center px-4 relative z-10">
        <a href="{% url 'dashboard' %}" class="group flex items-center gap-2 text-primary font-black transition-all">
            <span class="material-symbols-outlined transition-transform group-hover:-translate-x-2">arrow_back_ios</span>
            Volver a la aventura
        </a>
        <div class="flex items-center gap-2 bg-white/80 backdrop-blur-md px-5 py-2 rounded-full shadow-sm border-2 border-soft-pink">
            <span class="material-symbols-outlined text-primary font-variation-fill">pets</span>
            <span class="font-black text-slate-800 text-sm tracking-tight">MI PERFIL</span>
        </div>
    </div>

    <main class="max-w-6xl mx-auto relative z-10">
        
        <div class="rainbow-card rounded-[3.5rem] p-8 md:p-12 mb-10 flex flex-col md:flex-row items-center gap-10 bg-white shadow-2xl transition-all hover:-translate-y-1">
            <div class="relative">
                <div class="bg-white p-4 rounded-[3rem] shadow-2xl rotate-3 group-hover:rotate-0 transition-transform border-4 border-soft-pink">
                    {% if user.profile.avatar == 'lumi' %}
                        <img src="{% static 'core/img/lumi_icon.png' %}" class="w-32 h-32 md:w-44 md:h-44 object-contain" alt="Lumi">
                    {% else %}
                        <img src="{% static 'core/img/gumi_icon.png' %}" class="w-32 h-32 md:w-44 md:h-44 object-contain" alt="Gumi">
                    {% endif %}
                </div>
                <div class="absolute -bottom-2 -right-2 bg-yellow-400 text-white p-3 rounded-2xl shadow-lg border-4 border-white animate-bounce" style="animation-duration: 3s;">
                    <span class="material-symbols-outlined font-variation-fill">stars</span>
                </div>
            </div>

            <div class="text-center md:text-left space-y-3">
                <div class="flex flex-wrap justify-center md:justify-start gap-3">
                    <span class="bg-primary/10 text-primary px-5 py-1.5 rounded-full text-xs font-black uppercase tracking-widest border border-primary/20">
                        Nivel {{ user.profile.level }}
                    </span>
                    <span class="bg-blue-500 text-white px-5 py-1.5 rounded-full text-xs font-black uppercase tracking-widest shadow-lg shadow-blue-200">
                        {{ user.profile.xp }} XP Totales
                    </span>
                </div>
                <h1 class="text-4xl md:text-6xl font-black text-slate-800 tracking-tight">¡Hola, {{ user.first_name }}!</h1>
                <p class="text-slate-400 font-bold italic text-lg opacity-80">Explorando como @{{ user.username }}</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 space-y-6">
                <div class="glass-card p-8 md:p-12 border-b-[12px] border-primary/5">
                    <div class="flex justify-between items-center mb-10">
                        <div class="flex items-center gap-4">
                            <div class="bg-soft-blue p-3 rounded-2xl">
                                <span class="material-symbols-outlined text-blue-600 font-variation-fill">badge</span>
                            </div>
                            <h3 class="text-2xl font-black text-slate-800">Datos Personales</h3>
                        </div>
                        <button id="edit-btn" onclick="toggleEdit()" class="bg-soft-pink text-primary px-8 py-3 rounded-2xl font-black text-sm hover:scale-110 transition-all border-2 border-white shadow-md">
                            Editar Perfil
                        </button>
                    </div>

                    <form id="profile-form" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {% csrf_token %}
                        <div class="space-y-3">
                            <label class="text-xs font-black text-slate-400 uppercase ml-5 tracking-widest">Apodo Mágico</label>
                            <input type="text" name="username" id="input-username" value="{{ user.username }}" disabled
                                class="w-full data-pill p-5 font-bold text-slate-700 outline-none focus:ring-4 focus:ring-primary/10 disabled:opacity-60 transition-all">
                        </div>
                        <div class="space-y-3">
                            <label class="text-xs font-black text-slate-400 uppercase ml-5 tracking-widest">Nombre</label>
                            <input type="text" name="first_name" id="input-first_name" value="{{ user.first_name }}" disabled
                                class="w-full data-pill p-5 font-bold text-slate-700 outline-none focus:ring-4 focus:ring-primary/10 disabled:opacity-60 transition-all">
                        </div>
                        <div class="space-y-3">
                            <label class="text-xs font-black text-slate-400 uppercase ml-5 tracking-widest">Apellido</label>
                            <input type="text" name="last_name" id="input-last_name" value="{{ user.last_name }}" disabled
                                class="w-full data-pill p-5 font-bold text-slate-700 outline-none focus:ring-4 focus:ring-primary/10 disabled:opacity-60 transition-all">
                        </div>
                        <div class="space-y-3">
                            <label class="text-xs font-black text-slate-400 uppercase ml-5 tracking-widest">Correo Secreto</label>
                            <input type="email" name="email" id="input-email" value="{{ user.email }}" disabled
                                class="w-full data-pill p-5 font-bold text-slate-700 outline-none focus:ring-4 focus:ring-primary/10 disabled:opacity-60 transition-all">
                        </div>

                        <div id="action-buttons" class="md:col-span-2 flex justify-end gap-4 hidden mt-6 animate-fade-in">
                            <button type="button" onclick="toggleEdit()" class="px-8 py-4 rounded-[1.5rem] font-black text-slate-400 hover:bg-slate-100 transition-all uppercase text-xs">
                                Cancelar
                            </button>
                            <button type="submit" class="bg-primary text-white px-10 py-4 rounded-[1.5rem] font-black shadow-xl shadow-primary/20 hover:scale-105 transition-all uppercase text-xs tracking-widest border-b-4 border-pink-800">
                                Guardar Cambios ✨
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="space-y-6">
                <div class="glass-card p-8 text-center border-b-8 border-soft-blue relative group">
                    <div class="absolute top-4 right-4 bg-soft-blue/50 p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="material-symbols-outlined text-blue-500 animate-spin-slow">settings</span>
                    </div>
                    
                    <img src="{% if user.profile.avatar == 'lumi' %}{% static 'core/img/gumi_icon.png' %}{% else %}{% static 'core/img/lumi_icon.png' %}{% endif %}" 
                         class="w-32 h-32 mx-auto mb-6 float-anim cursor-pointer" alt="Mascota Secundaria">
                    
                    <div class="bg-slate-50 rounded-[2rem] p-6 border-2 border-slate-100 relative">
                        <div class="absolute -top-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-slate-50 border-t-2 border-l-2 border-slate-100 rotate-45"></div>
                        <p class="text-sm font-bold text-slate-600 leading-relaxed italic">
                            "¡Tienes <span class="text-primary font-black">{{ user.profile.xp }} XP</span>! Cada línea de código te hace más fuerte."
                        </p>
                    </div>

                    <div class="mt-6 space-y-3">
                        <a href="{% url 'logros' %}" class="block">
                        <button class="w-full bg-slate-800 text-white py-4 rounded-2xl font-black shadow-lg hover:scale-105 transition-all flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined">military_tech</span>
                            VER MIS LOGROS
                        </button>
                        </a>
                        <a href="{% url 'feedback_page' %}" class="block">
                            <button class="w-full bg-white text-primary border-2 border-primary/20 py-4 rounded-2xl font-black hover:bg-soft-pink transition-all">
                                ¡DANOS TU OPINIÓN!
                            </button>
                        </a>
                    </div>
                </div>

                <form action="{% url 'logout' %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="w-full p-6 bg-white text-red-400 rounded-[2.5rem] font-black flex items-center justify-center gap-3 hover:bg-red-50 hover:text-red-600 transition-all shadow-sm border-2 border-transparent hover:border-red-100">
                        <span class="material-symbols-outlined">power_settings_new</span> 
                        CERRAR SESIÓN
                    </button>
                </form>
            </div>

        </div>
    </main>
</div>

<footer class="relative w-full bg-[#4c1d95] pt-20 pb-10 px-6 md:px-20 text-white rounded-t-[5rem] overflow-hidden">
    <div class="absolute inset-0 overflow-hidden pointer-events-none opacity-30">
        <div class="absolute top-10 left-[10%] w-2 h-2 bg-pink-400 rounded-full animate-pulse"></div>
        <div class="absolute top-20 left-[80%] w-3 h-3 bg-lila-main rounded-full animate-bounce" style="animation-duration: 3s;"></div>
        <div class="absolute bottom-10 left-[40%] w-2 h-2 bg-blue-400 rounded-full animate-pulse" style="animation-delay: 1s;"></div>
    </div>

    <div class="max-w-7xl mx-auto relative z-10">
        <div class="flex flex-col md:flex-row justify-between items-center gap-12 mb-12">
            
            <div class="group flex items-center gap-4 cursor-pointer">
                <div class="relative">
                    <div class="absolute inset-0 bg-pink-magic blur-lg opacity-40 group-hover:opacity-100 transition-all"></div>
                    <div class="relative w-14 h-14 bg-gradient-to-br from-pink-magic to-lila-dark rounded-2xl flex items-center justify-center shadow-xl transform group-hover:rotate-[360deg] duration-700 transition-all">
                        <span class="material-symbols-outlined text-3xl text-white" style="font-variation-settings: 'FILL' 1">pets</span>
                    </div>
                </div>
                <div class="flex flex-col">
                    <span class="font-kids font-bold text-3xl tracking-tight">Gumi & Lumi</span>
                    <span class="text-[10px] font-black text-pink-300 uppercase tracking-[0.3em]">Code Academy</span>
                </div>
            </div>

            <div class="flex flex-wrap justify-center gap-4">
                <a href="{% url 'terminos' %}" class="group flex items-center gap-2 px-6 py-3 bg-white/10 hover:bg-white/20 rounded-2xl transition-all border border-white/10 hover:-translate-y-2 btn-pop">
                    <span class="material-symbols-outlined text-pink-300 group-hover:scale-125 transition-transform">category</span>
                    <span class="font-bold text-sm">Términos</span>
                </a>
                <a href="{% url 'soporte' %}" class="group flex items-center gap-2 px-6 py-3 bg-white/10 hover:bg-white/20 rounded-2xl transition-all border border-white/10 hover:-translate-y-2 btn-pop">
                    <span class="material-symbols-outlined text-yellow-300 group-hover:scale-125 transition-transform">support</span>
                    <span class="font-bold text-sm">Soporte</span>
                </a>
                <a href="{% url 'feedback_page' %}" class="group flex items-center gap-2 px-6 py-3 bg-white/10 hover:bg-white/20 rounded-2xl transition-all border border-white/10 hover:-translate-y-2 btn-pop">
                    <span class="material-symbols-outlined text-blue-300 group-hover:scale-125 transition-transform">sticker</span>
                    <span class="font-bold text-sm">Comentarios</span>
                </a>
            </div>

            <div class="flex gap-4">
                <a href="#" class="w-12 h-12 flex items-center justify-center rounded-full bg-white/5 hover:bg-pink-magic hover:shadow-[0_0_20px_rgba(236,72,153,0.5)] transition-all group btn-pop">
                    <span class="material-symbols-outlined text-2xl group-hover:animate-wiggle">chat_bubble</span>
                </a>
                <a href="#" class="w-12 h-12 flex items-center justify-center rounded-full bg-white/5 hover:bg-lila-main hover:shadow-[0_0_20px_rgba(167,139,250,0.5)] transition-all group btn-pop">
                    <span class="material-symbols-outlined text-2xl group-hover:animate-wiggle">mail</span>
                </a>
            </div>
        </div>

        <div class="w-full h-px bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>

        <div class="mt-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-2 text-lila-soft/60">
                <span class="material-symbols-outlined text-sm">favorite</span>
                <p class="font-medium text-sm">© T.M.L ✨ <span class="text-white/80">Aprender es la magia que cambia el mundo.</span></p>
            </div>
            
            <div class="flex items-center gap-3 px-4 py-2 bg-black/30 rounded-full border border-white/10">
                <div class="flex -space-x-2">
                    <div class="w-6 h-6 rounded-full border-2 border-[#4c1d95] bg-pink-400"></div>
                    <div class="w-6 h-6 rounded-full border-2 border-[#4c1d95] bg-blue-400"></div>
                    <div class="w-6 h-6 rounded-full border-2 border-[#4c1d95] bg-yellow-400"></div>
                </div>
                <span class="text-[10px] font-black text-green-400 uppercase tracking-widest animate-pulse">Servidores Activos</span>
            </div>
        </div>
    </div>

    <style>
        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(15deg); }
            75% { transform: rotate(-15deg); }
        }
        .group-hover\:animate-wiggle:hover {
            animation: wiggle 0.5s ease-in-out infinite;
        }
    </style>
</footer>

<style type="text/tailwindcss">
    @layer components {
        .glass-card { 
            @apply bg-white/90 backdrop-blur-sm border-4 border-white shadow-xl rounded-[3rem] transition-all duration-500; 
        }
        .glass-card:hover { @apply -translate-y-2 shadow-2xl; }
        
        .rainbow-card {
            background: linear-gradient(white, white) padding-box,
                        linear-gradient(120deg, #ff85a1, #bae6fd, #ffeb3b, #a5d6a7, #ff85a1) border-box;
            border: 8px solid transparent;
            background-size: 200% auto;
            animation: rainbow-border 8s linear infinite;
        }

        .data-pill {
            @apply bg-slate-50 border-2 border-slate-100 rounded-[1.5rem] transition-all duration-300;
        }

        .data-pill:not(:disabled):focus {
            @apply bg-white border-primary/30 shadow-lg shadow-primary/5;
        }

        .floating-icon { 
            @apply absolute pointer-events-none select-none opacity-10; 
            animation: float-around linear infinite; 
            font-variation-settings: 'FILL' 1; 
        }

        .magic-particle { 
            position: fixed; pointer-events: none; z-index: 9999; 
            animation: particle-explosion 1s ease-out forwards; 
            font-variation-settings: 'FILL' 1; 
        }

        .animate-success {
            @apply border-green-400 !important;
            animation: bounce 0.5s ease-in-out;
        }
    }

    @keyframes rainbow-border {
        0% { background-position: 0% 50%; }
        100% { background-position: 200% 50%; }
    }

    @keyframes float-around {
        0% { transform: translateY(110vh) rotate(0deg); opacity: 0; }
        10% { opacity: 0.1; }
        90% { opacity: 0.1; }
        100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
    }

    @keyframes particle-explosion {
        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
        100% { transform: translate(var(--tw-tx), var(--tw-ty)) scale(1.2) rotate(var(--tw-tr)); opacity: 0; }
    }

    .float-anim { animation: float 4s ease-in-out infinite; }
    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-15px); }
    }

    .animate-spin-slow { animation: spin 8s linear infinite; }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // 1. Iconos de Fondo
    const bgContainer = document.getElementById('magic-background');
    const icons = ['face', 'favorite', 'cruelty_free', 'pest_control_rodent', 'pets', 'auto_awesome', 'shield'];
    for (let i = 0; i < 15; i++) {
        const span = document.createElement('span');
        span.classList.add('material-symbols-outlined', 'floating-icon');
        span.innerText = icons[Math.floor(Math.random() * icons.length)];
        span.style.left = Math.random() * 100 + '%';
        span.style.animationDuration = 20 + Math.random() * 20 + 's';
        span.style.animationDelay = -Math.random() * 10 + 's';
        span.style.fontSize = 20 + Math.random() * 30 + 'px';
        span.style.color = '#ee2b6c';
        bgContainer.appendChild(span);
    }

    // 2. Partículas del Ratón
    document.addEventListener('mousemove', (e) => {
        if (Math.random() > 0.15) return;
        const p = document.createElement('span');
        p.classList.add('material-symbols-outlined', 'magic-particle');
        p.innerText = 'favorite';
        p.style.color = ['#ff85a1', '#ee2b6c', '#bae6fd'][Math.floor(Math.random()*3)];
        p.style.left = e.clientX + 'px'; p.style.top = e.clientY + 'px';
        p.style.setProperty('--tw-tx', `${(Math.random()-0.5)*150}px`);
        p.style.setProperty('--tw-ty', `${(Math.random()-0.5)*150}px`);
        p.style.setProperty('--tw-tr', `${(Math.random()-0.5)*500}deg`);
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 1000);
    });

    // 3. Lógica de Edición
    function toggleEdit() {
        const form = document.getElementById('profile-form');
        const inputs = form.querySelectorAll('input');
        const actionButtons = document.getElementById('action-buttons');
        const editBtn = document.getElementById('edit-btn');
        const isDisabled = inputs[0].disabled;

        inputs.forEach(input => {
            input.disabled = !isDisabled;
            if(!isDisabled) {
                input.classList.remove('bg-white');
            } else {
                input.classList.add('bg-white');
            }
        });

        actionButtons.classList.toggle('hidden');
        editBtn.classList.toggle('hidden');
    }

    document.getElementById('profile-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const submitBtn = this.querySelector('button[type="submit"]');
        const card = document.querySelector('.lg:col-span-2 > div');
        
        submitBtn.disabled = true;
        submitBtn.innerText = "HECHIZO EN CURSO... ⏳";
        
        const formData = new FormData(this);
        
        fetch("{% url 'update_profile' %}", {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(response => response.json())
        .then(data => {
            submitBtn.disabled = false;
            submitBtn.innerText = "Guardar Cambios ✨";

            if (data.status === 'ok') {
                toggleEdit();
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#ee2b6c', '#0369a1', '#facc15']
                });
                card.classList.add('animate-success');
                setTimeout(() => card.classList.remove('animate-success'), 1000);
            } else {
                Swal.fire('¡Ups!', data.message, 'error');
            }
        });
    });
</script>
{% endblock %}